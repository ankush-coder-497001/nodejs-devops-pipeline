name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest


    steps:
    - name: checkout code
      uses: actions/checkout@v3

    - name: setup node
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: install Dependencies
      run: npm install

    - name: run tests
      run: npm test

    - name: Login To Docker
      uses: docker/login-action@v3
      with:  
        username: ${{secrets.DOCKER_USERNAME}}
        password: ${{secrets.DOCKER_PASSWORD}}

    - name: Build the image
      run: |
        docker build -t ${{secrets.DOCKER_USERNAME}}/devops-app:${{github.sha}} .
        docker tag ${{secrets.DOCKER_USERNAME}}/devops-app:${{github.sha}} ${{secrets.DOCKER_USERNAME}}/devops-app:latest
      
    # - name: Scan Docker image for vulnerabilities
    #   uses: aquasecurity/trivy-action@master
    #   with:
    #     image-ref: ${{secrets.DOCKER_USERNAME}}/devops-app:${{github.sha}}
    #     format: table
    #     exit-code: 1
    #     severity: HIGH,CRITICAL
    #     ignore-unfixed: true
        
    - name: push docker image
      run: |
        docker push ${{secrets.DOCKER_USERNAME}}/devops-app:${{github.sha}}
        docker push ${{secrets.DOCKER_USERNAME}}/devops-app:latest 

    - name: Validate Kubernetes Manifests (dry run)
      run: |
        kubectl apply --dry-run=client --validate=false -f k8s/
     
    # - name: Setup kubectl
    #   uses: azure/setup-kubectl@v3
    #   with:
    #     version: 'latest'

    # - name: Deploy to Kubernetes
    #   env:
    #     KUBE_CONFIG_DATA: ${{secrets.KUBE_CONFIG_DATA}}
    #   run: |
    #    echo "$KUBE_CONFIG_DATA" | base64 --decode > kubeconfig
    #    export KUBECONFIG=$PWD/kubeconfig
    #    kubectl set image deployment/devops-deployment devops-container=${{secrets.DOCKER_USERNAME}}/devops-app:${{github.sha}} -n devops-ns 


  notify-on-failure:
    needs: build
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Email on CI Failure 
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{secrets.EMAIL_USERNAME}}
          password: ${{secrets.EMAIL_PASSWORD}}
          subject: "‚ùå CI Pipeline Failed"
          body: |
            Hello,

            The CI pipeline for the repository has failed. Please check the details below:

            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            Job: ${{ github.job }}

            Please take the necessary actions to resolve the issues.

            Best Regards,
            DevOps Team
          to: ankushcoder497001@gmail.com 
          from:  "DevOps CI <ankushgupta997769@gmail.com>"

